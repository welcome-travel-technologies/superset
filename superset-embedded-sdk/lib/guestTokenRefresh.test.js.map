{"version":3,"file":"guestTokenRefresh.test.js","names":["_guestTokenRefresh","require","describe","beforeAll","jest","useFakeTimers","setSystemTime","Date","spyOn","global","afterAll","useRealTimers","makeFakeJWT","claims","tokenifiedClaims","Buffer","from","JSON","stringify","toString","it","ttl","exp","now","fakeToken","timing","getGuestTokenRefreshTiming","expect","toBeGreaterThan","MIN_REFRESH_WAIT_MS","toBe","REFRESH_TIMING_BUFFER_MS","toISOString","expectedTiming","DEFAULT_TOKEN_EXP_MS"],"sources":["../src/guestTokenRefresh.test.ts"],"sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n\nimport {\n  REFRESH_TIMING_BUFFER_MS,\n  getGuestTokenRefreshTiming,\n  MIN_REFRESH_WAIT_MS,\n  DEFAULT_TOKEN_EXP_MS,\n} from \"./guestTokenRefresh\";\n\ndescribe(\"guest token refresh\", () => {\n  beforeAll(() => {\n    jest.useFakeTimers(\"modern\"); // \"modern\" allows us to fake the system time\n    jest.setSystemTime(new Date(\"2022-03-03 01:00\"));\n    jest.spyOn(global, \"setTimeout\");\n  });\n\n  afterAll(() => {\n    jest.useRealTimers();\n  });\n\n  function makeFakeJWT(claims: any) {\n    // not a valid jwt, but close enough for this code\n    const tokenifiedClaims = Buffer.from(JSON.stringify(claims)).toString(\n      \"base64\"\n    );\n    return `abc.${tokenifiedClaims}.xyz`;\n  }\n\n  it(\"schedules refresh with an epoch exp\", () => {\n    // exp is in seconds\n    const ttl = 1300;\n    const exp = Date.now() / 1000 + ttl;\n    const fakeToken = makeFakeJWT({ exp });\n\n    const timing = getGuestTokenRefreshTiming(fakeToken);\n\n    expect(timing).toBeGreaterThan(MIN_REFRESH_WAIT_MS);\n    expect(timing).toBe(ttl * 1000 - REFRESH_TIMING_BUFFER_MS);\n  });\n\n  it(\"schedules refresh with an epoch exp containing a decimal\", () => {\n    const ttl = 1300.123;\n    const exp = Date.now() / 1000 + ttl;\n    const fakeToken = makeFakeJWT({ exp });\n\n    const timing = getGuestTokenRefreshTiming(fakeToken);\n\n    expect(timing).toBeGreaterThan(MIN_REFRESH_WAIT_MS);\n    expect(timing).toBe(ttl * 1000 - REFRESH_TIMING_BUFFER_MS);\n  });\n\n  it(\"schedules refresh with iso exp\", () => {\n    const exp = new Date(\"2022-03-03 01:09\").toISOString();\n    const fakeToken = makeFakeJWT({ exp });\n\n    const timing = getGuestTokenRefreshTiming(fakeToken);\n    const expectedTiming = 1000 * 60 * 9 - REFRESH_TIMING_BUFFER_MS;\n\n    expect(timing).toBeGreaterThan(MIN_REFRESH_WAIT_MS);\n    expect(timing).toBe(expectedTiming);\n  });\n\n  it(\"avoids refresh spam\", () => {\n    const fakeToken = makeFakeJWT({ exp: Date.now() / 1000 });\n\n    const timing = getGuestTokenRefreshTiming(fakeToken);\n\n    expect(timing).toBe(MIN_REFRESH_WAIT_MS - REFRESH_TIMING_BUFFER_MS);\n  });\n\n  it(\"uses a default when it cannot parse the date\", () => {\n    const fakeToken = makeFakeJWT({ exp: \"invalid date\" });\n\n    const timing = getGuestTokenRefreshTiming(fakeToken);\n\n    expect(timing).toBeGreaterThan(MIN_REFRESH_WAIT_MS);\n    expect(timing).toBe(DEFAULT_TOKEN_EXP_MS - REFRESH_TIMING_BUFFER_MS);\n  });\n});\n"],"mappings":"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"}