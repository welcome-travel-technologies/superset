{"version":3,"file":"index.js","names":["_const","require","_switchboard","_guestTokenRefresh","embedDashboard","id","supersetDomain","mountPoint","fetchGuestToken","dashboardUiConfig","debug","log","info","console","endsWith","slice","calculateConfig","configNumber","hideTitle","hideTab","hideChartControls","mountIframe","Promise","resolve","iframe","document","createElement","dashboardConfig","filterConfig","filters","filterConfigKeys","Object","keys","filterConfigUrlParams","length","map","key","DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY","join","sandbox","add","addEventListener","commsChannel","MessageChannel","ourPort","port1","theirPort","port2","contentWindow","postMessage","type","IFRAME_COMMS_MESSAGE_TYPE","handshake","Switchboard","port","name","src","replaceChildren","guestToken","all","emit","refreshGuestToken","newGuestToken","setTimeout","getGuestTokenRefreshTiming","unmount","getScrollSize","get","getDashboardPermalink","anchor","getActiveTabs"],"sources":["../src/index.ts"],"sourcesContent":["/*\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\n\nimport {\n  DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY,\n  IFRAME_COMMS_MESSAGE_TYPE\n} from './const';\n\n// We can swap this out for the actual switchboard package once it gets published\nimport { Switchboard } from '@superset-ui/switchboard';\nimport { getGuestTokenRefreshTiming } from './guestTokenRefresh';\n\n/**\n * The function to fetch a guest token from your Host App's backend server.\n * The Host App backend must supply an API endpoint\n * which returns a guest token with appropriate resource access.\n */\nexport type GuestTokenFetchFn = () => Promise<string>;\n\nexport type UiConfigType = {\n  hideTitle?: boolean\n  hideTab?: boolean\n  hideChartControls?: boolean\n  filters?: {\n    [key: string]: boolean | undefined\n    visible?: boolean\n    expanded?: boolean\n  }\n}\n\nexport type EmbedDashboardParams = {\n  /** The id provided by the embed configuration UI in Superset */\n  id: string\n  /** The domain where Superset can be located, with protocol, such as: https://superset.example.com */\n  supersetDomain: string\n  /** The html element within which to mount the iframe */\n  mountPoint: HTMLElement\n  /** A function to fetch a guest token from the Host App's backend server */\n  fetchGuestToken: GuestTokenFetchFn\n  /** The dashboard UI config: hideTitle, hideTab, hideChartControls, filters.visible, filters.expanded **/\n  dashboardUiConfig?: UiConfigType\n  /** Are we in debug mode? */\n  debug?: boolean\n}\n\nexport type Size = {\n  width: number, height: number\n}\n\nexport type EmbeddedDashboard = {\n  getScrollSize: () => Promise<Size>\n  unmount: () => void\n  getDashboardPermalink: (anchor: string) => Promise<string>\n  getActiveTabs: () => Promise<string[]>\n}\n\n/**\n * Embeds a Superset dashboard into the page using an iframe.\n */\nexport async function embedDashboard({\n  id,\n  supersetDomain,\n  mountPoint,\n  fetchGuestToken,\n  dashboardUiConfig,\n  debug = false\n}: EmbedDashboardParams): Promise<EmbeddedDashboard> {\n  function log(...info: unknown[]) {\n    if (debug) {\n      console.debug(`[superset-embedded-sdk][dashboard ${id}]`, ...info);\n    }\n  }\n\n  log('embedding');\n\n  if (supersetDomain.endsWith(\"/\")) {\n    supersetDomain = supersetDomain.slice(0, -1);\n  }\n\n  function calculateConfig() {\n    let configNumber = 0\n    if(dashboardUiConfig) {\n      if(dashboardUiConfig.hideTitle) {\n        configNumber += 1\n      }\n      if(dashboardUiConfig.hideTab) {\n        configNumber += 2\n      }\n      if(dashboardUiConfig.hideChartControls) {\n        configNumber += 8\n      }\n    }\n    return configNumber\n  }\n\n  async function mountIframe(): Promise<Switchboard> {\n    return new Promise(resolve => {\n      const iframe = document.createElement('iframe');\n      const dashboardConfig = dashboardUiConfig ? `?uiConfig=${calculateConfig()}` : \"\"\n      const filterConfig = dashboardUiConfig?.filters || {}\n      const filterConfigKeys = Object.keys(filterConfig)\n      const filterConfigUrlParams = filterConfigKeys.length > 0\n        ? \"&\"\n        + filterConfigKeys\n          .map(key => DASHBOARD_UI_FILTER_CONFIG_URL_PARAM_KEY[key] + '=' + filterConfig[key]).join('&')\n        : \"\"\n\n      // set up the iframe's sandbox configuration\n      iframe.sandbox.add(\"allow-same-origin\"); // needed for postMessage to work\n      iframe.sandbox.add(\"allow-scripts\"); // obviously the iframe needs scripts\n      iframe.sandbox.add(\"allow-presentation\"); // for fullscreen charts\n      iframe.sandbox.add(\"allow-downloads\"); // for downloading charts as image\n      iframe.sandbox.add(\"allow-forms\"); // for forms to submit\n      iframe.sandbox.add(\"allow-popups\"); // for exporting charts as csv\n      // add these if it turns out we need them:\n      // iframe.sandbox.add(\"allow-top-navigation\");\n\n      // add the event listener before setting src, to be 100% sure that we capture the load event\n      iframe.addEventListener('load', () => {\n        // MessageChannel allows us to send and receive messages smoothly between our window and the iframe\n        // See https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\n        const commsChannel = new MessageChannel();\n        const ourPort = commsChannel.port1;\n        const theirPort = commsChannel.port2;\n\n        // Send one of the message channel ports to the iframe to initialize embedded comms\n        // See https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage\n        // we know the content window isn't null because we are in the load event handler.\n        iframe.contentWindow!.postMessage(\n          { type: IFRAME_COMMS_MESSAGE_TYPE, handshake: \"port transfer\" },\n          supersetDomain,\n          [theirPort],\n        )\n        log('sent message channel to the iframe');\n\n        // return our port from the promise\n        resolve(new Switchboard({ port: ourPort, name: 'superset-embedded-sdk', debug }));\n      });\n\n      iframe.src = `${supersetDomain}/embedded/${id}${dashboardConfig}${filterConfigUrlParams}`;\n      //@ts-ignore\n      mountPoint.replaceChildren(iframe);\n      log('placed the iframe')\n    });\n  }\n\n  const [guestToken, ourPort]: [string, Switchboard] = await Promise.all([\n    fetchGuestToken(),\n    mountIframe(),\n  ]);\n\n  ourPort.emit('guestToken', { guestToken });\n  log('sent guest token');\n\n  async function refreshGuestToken() {\n    const newGuestToken = await fetchGuestToken();\n    ourPort.emit('guestToken', { guestToken: newGuestToken });\n    setTimeout(refreshGuestToken, getGuestTokenRefreshTiming(newGuestToken));\n  }\n\n  setTimeout(refreshGuestToken, getGuestTokenRefreshTiming(guestToken));\n\n  function unmount() {\n    log('unmounting');\n    //@ts-ignore\n    mountPoint.replaceChildren();\n  }\n\n  const getScrollSize = () => ourPort.get<Size>('getScrollSize');\n  const getDashboardPermalink = (anchor: string) =>\n    ourPort.get<string>('getDashboardPermalink', { anchor });\n  const getActiveTabs = () => ourPort.get<string[]>('getActiveTabs')\n\n  return {\n    getScrollSize,\n    unmount,\n    getDashboardPermalink,\n    getActiveTabs,\n  };\n}\n"],"mappings":"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"}